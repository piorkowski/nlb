{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    Wpisywanie wyników: {{ game }}
{% endblock %}

{% block main %}
    <div class="content-panel">
        <form method="post" action="{{ path('admin_game_scores_save', {id: game.id}) }}">
            <input type="hidden" name="_token" value="{{ csrf_token('game_scores_' ~ game.id) }}">

            {# Gra 1 #}
            {% if gamesByNumber[1] is defined %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fa fa-bowling-ball"></i> Gra 1
                            {% if gamesByNumber[1]|first %}
                                - Tor {{ gamesByNumber[1]|first.laneNumber }}
                            {% endif %}
                        </h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <thead class="table-dark">
                                <tr>
                                    <th style="width: 200px;">Zawodnik</th>
                                    {% for frame in gamesByNumber[1] %}
                                        <th class="text-center" style="min-width: 80px;">{{ frame.frameNumber }}</th>
                                    {% endfor %}
                                    <th class="text-center" style="width: 80px;">Suma</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for player in players %}
                                    <tr>
                                        <td class="fw-bold">{{ player.fullName }}</td>
                                        {% set cumulativeScore = 0 %}
                                        {% for idx, frame in gamesByNumber[1] %}
                                            <td class="text-center p-1">
                                                {% set playerRolls = frame.getPlayerPins(player) %}
                                                {% set currentValue = '' %}
                                                {% if playerRolls|length > 0 %}
                                                    {% if frame.frameNumber == 10 %}
                                                        {% set parts = [] %}
                                                        {% for rollNum, pins in playerRolls %}
                                                            {% if pins == 10 %}
                                                                {% set parts = parts|merge(['X']) %}
                                                            {% elseif rollNum > 1 and (playerRolls[rollNum-1] ?? 0) + pins == 10 %}
                                                                {% set parts = parts|merge(['/']) %}
                                                            {% else %}
                                                                {% set parts = parts|merge([pins == 0 ? '-' : pins]) %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        {% set currentValue = parts|join(',') %}
                                                    {% else %}
                                                        {% if playerRolls[1] == 10 %}
                                                            {% set currentValue = 'X' %}
                                                        {% elseif playerRolls|length == 2 and (playerRolls[1] + playerRolls[2]) == 10 %}
                                                            {% set currentValue = (playerRolls[1] == 0 ? '-' : playerRolls[1]) ~ '/' %}
                                                        {% else %}
                                                            {% set parts = [] %}
                                                            {% for rollNum, pins in playerRolls %}
                                                                {% set parts = parts|merge([pins == 0 ? '-' : pins]) %}
                                                            {% endfor %}
                                                            {% set currentValue = parts|join(',') %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                                <input type="text"
                                                       name="scores[{{ frame.id }}][{{ player.id }}]"
                                                       value="{{ currentValue }}"
                                                       class="form-control form-control-sm text-center"
                                                       placeholder="{% if frame.frameNumber == 10 %}X,X,X{% else %}X{% endif %}"
                                                       style="font-size: 0.9rem; margin-bottom: 4px;">

                                                {# Oblicz punkty z bonusami #}
                                                {% set nextFrame = gamesByNumber[1][idx + 1] ?? null %}
                                                {% set nextNextFrame = gamesByNumber[1][idx + 2] ?? null %}
                                                {% set frameScore = frame.calculatePlayerScore(player, nextFrame, nextNextFrame) %}
                                                {% set cumulativeScore = cumulativeScore + frameScore %}

                                                {# Wyświetl kumulatywny wynik #}
                                                <div style="font-size: 0.85rem; font-weight: bold; color: #0d6efd;">
                                                    {{ cumulativeScore }}
                                                </div>
                                            </td>
                                        {% endfor %}
                                        <td class="text-center fw-bold bg-warning">
                                            {{ cumulativeScore }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}

            {# Gra 2 #}
            {% if gamesByNumber[2] is defined %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fa fa-bowling-ball"></i> Gra 2
                            {% if gamesByNumber[2]|first %}
                                - Tor {{ gamesByNumber[2]|first.laneNumber }}
                            {% endif %}
                        </h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <thead class="table-dark">
                                <tr>
                                    <th style="width: 200px;">Zawodnik</th>
                                    {% for frame in gamesByNumber[2] %}
                                        <th class="text-center" style="min-width: 80px;">{{ frame.frameNumber }}</th>
                                    {% endfor %}
                                    <th class="text-center" style="width: 80px;">Suma</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for player in players %}
                                    <tr>
                                        <td class="fw-bold">{{ player.fullName }}</td>
                                        {% set cumulativeScore = 0 %}
                                        {% for idx, frame in gamesByNumber[2] %}
                                            <td class="text-center p-1">
                                                {% set playerRolls = frame.getPlayerPins(player) %}
                                                {% set currentValue = '' %}
                                                {% if playerRolls|length > 0 %}
                                                    {% if frame.frameNumber == 10 %}
                                                        {% set parts = [] %}
                                                        {% for rollNum, pins in playerRolls %}
                                                            {% if pins == 10 %}
                                                                {% set parts = parts|merge(['X']) %}
                                                            {% elseif rollNum > 1 and (playerRolls[rollNum-1] ?? 0) + pins == 10 %}
                                                                {% set parts = parts|merge(['/']) %}
                                                            {% else %}
                                                                {% set parts = parts|merge([pins == 0 ? '-' : pins]) %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        {% set currentValue = parts|join(',') %}
                                                    {% else %}
                                                        {% if playerRolls[1] == 10 %}
                                                            {% set currentValue = 'X' %}
                                                        {% elseif playerRolls|length == 2 and (playerRolls[1] + playerRolls[2]) == 10 %}
                                                            {% set currentValue = (playerRolls[1] == 0 ? '-' : playerRolls[1]) ~ '/' %}
                                                        {% else %}
                                                            {% set parts = [] %}
                                                            {% for rollNum, pins in playerRolls %}
                                                                {% set parts = parts|merge([pins == 0 ? '-' : pins]) %}
                                                            {% endfor %}
                                                            {% set currentValue = parts|join(',') %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                                <input type="text"
                                                       name="scores[{{ frame.id }}][{{ player.id }}]"
                                                       value="{{ currentValue }}"
                                                       class="form-control form-control-sm text-center"
                                                       placeholder="{% if frame.frameNumber == 10 %}X,X,X{% else %}X{% endif %}"
                                                       style="font-size: 0.9rem; margin-bottom: 4px;">

                                                {# Oblicz punkty z bonusami #}
                                                {% set nextFrame = gamesByNumber[2][idx + 1] ?? null %}
                                                {% set nextNextFrame = gamesByNumber[2][idx + 2] ?? null %}
                                                {% set frameScore = frame.calculatePlayerScore(player, nextFrame, nextNextFrame) %}
                                                {% set cumulativeScore = cumulativeScore + frameScore %}

                                                {# Wyświetl kumulatywny wynik #}
                                                <div style="font-size: 0.85rem; font-weight: bold; color: #0d6efd;">
                                                    {{ cumulativeScore }}
                                                </div>
                                            </td>
                                        {% endfor %}
                                        <td class="text-center fw-bold bg-warning">
                                            {{ cumulativeScore }}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endif %}

            {# Suma całkowita #}
            <div class="alert alert-primary">
                <h5><i class="fa fa-trophy"></i> Wynik całkowity (suma z 2 gier):</h5>
                <div class="row">
                    {% for player in players %}
                        <div class="col">
                            <strong>{{ player.fullName }}:</strong>
                            <span class="badge bg-primary" style="font-size: 1.3rem;">
                            {{ game.getPlayerTotalScore(player) }}
                        </span>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <div class="form-actions d-flex justify-content-between align-items-center mt-3">
                <div>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fa fa-save"></i> Zapisz wyniki
                    </button>
                    <a href="{{ path('admin') }}?crudAction=detail&crudControllerFqcn=App\\Controller\\Admin\\GameCrudController&entityId={{ game.id }}"
                       class="btn btn-secondary">
                        <i class="fa fa-arrow-left"></i> Powrót
                    </a>
                </div>
            </div>
        </form>

        <div class="alert alert-info mt-4">
            <h6 class="alert-heading">Format wpisywania:</h6>
            <ul class="mb-0 small">
                <li><code>X</code> - strike (10 kręgli w pierwszym rzucie)</li>
                <li><code>7/</code> - spare (pierwszy rzut + drugi = 10), np. 7 kręgli + 3 kręgle</li>
                <li><code>7,2</code> - dwa rzuty oddzielone przecinkiem</li>
                <li><code>-</code> lub <code>0</code> - pudło (0 kręgli)</li>
                <li><strong>Frame 10:</strong> może mieć 2-3 rzuty, np. <code>X,X,X</code>, <code>7/,X</code>, <code>8,1</code></li>
            </ul>
        </div>
    </div>
{% endblock %}
