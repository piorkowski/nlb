{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    Generuj strukturę meczu {{ game }}
{% endblock %}

{% block main %}
    <div class="card">
        <div class="card-header">
            <h3>Mecz: {{ game.league.name }}</h3>
            <p class="text-muted">
                Data: {{ game.gameDate|date('d.m.Y H:i') }}<br>
                {% if game.teamA and game.teamB %}
                    Drużyny: {{ game.teamA.name }} vs {{ game.teamB.name }}
                {% endif %}
            </p>
        </div>
        <div class="card-body">
            {% if not isReady %}
                <div class="alert alert-info">
                    <i class="fa fa-info-circle"></i> Wybierz graczy i wygeneruj strukturę meczu.
                </div>

                <form method="post" action="{{ ea_url().setController('App\\Controller\\Admin\\GameGenerateController').setAction('processGenerate').set('gameId', game.id) }}">
                    <input type="hidden" name="_token" value="{{ csrf_token('game_generate_' ~ game.id) }}">

                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link {% if not game.isTeamGame %}active{% endif %}"
                               data-bs-toggle="tab"
                               href="#individual"
                               onclick="document.getElementById('gameTypeIndividual').checked = true;">
                                Gra indywidualna (1 vs 1)
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {% if game.isTeamGame %}active{% endif %}"
                               data-bs-toggle="tab"
                               href="#team"
                               onclick="document.getElementById('gameTypeTeam').checked = true;">
                                Gra drużynowa (3 vs 3)
                            </a>
                        </li>
                    </ul>

                    <input type="radio" name="gameType" value="individual" id="gameTypeIndividual"
                           {% if not game.isTeamGame %}checked{% endif %} style="display:none">
                    <input type="radio" name="gameType" value="team" id="gameTypeTeam"
                           {% if game.isTeamGame %}checked{% endif %} style="display:none">

                    <div class="tab-content">
                        <div class="tab-pane fade {% if not game.isTeamGame %}show active{% endif %}" id="individual">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label required">Gracz A</label>
                                        <input type="text"
                                               class="form-control player-search mb-2"
                                               placeholder="Wyszukaj gracza..."
                                               data-target="playerA">
                                        <select name="individual[playerA]"
                                                id="playerA"
                                                class="form-select"
                                                size="10"
                                                required>
                                            <option value="">-- Wybierz gracza --</option>
                                            {% for player in players %}
                                                <option value="{{ player.id }}"
                                                        data-name="{{ player.fullName|lower }}"
                                                        data-league="{{ player.leagues|map(l => l.id)|join(',') }}">
                                                    {{ player.fullName }}
                                                    {% if player.leagues|length > 0 %}
                                                        <small class="text-muted">
                                                            ({{ player.leagues|map(l => l.name)|join(', ') }})
                                                        </small>
                                                    {% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label required">Gracz B</label>
                                        <input type="text"
                                               class="form-control player-search mb-2"
                                               placeholder="Wyszukaj gracza..."
                                               data-target="playerB">
                                        <select name="individual[playerB]"
                                                id="playerB"
                                                class="form-select"
                                                size="10"
                                                required>
                                            <option value="">-- Wybierz gracza --</option>
                                            {% for player in players %}
                                                <option value="{{ player.id }}"
                                                        data-name="{{ player.fullName|lower }}"
                                                        data-league="{{ player.leagues|map(l => l.id)|join(',') }}">
                                                    {{ player.fullName }}
                                                    {% if player.leagues|length > 0 %}
                                                        <small class="text-muted">
                                                            ({{ player.leagues|map(l => l.name)|join(', ') }})
                                                        </small>
                                                    {% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label class="form-label required">Początkowy tor</label>
                                <input type="number"
                                       name="individual[startLane]"
                                       class="form-control"
                                       value="1"
                                       min="1"
                                       max="20"
                                       required>
                                <small class="form-text text-muted">Na którym torze rozpocznie się mecz</small>
                            </div>
                        </div>

                        <div class="tab-pane fade {% if game.isTeamGame %}show active{% endif %}" id="team">
                            {% if game.teamA and game.teamB %}
                                <div class="row">
                                    <div class="col-md-6">
                                        <h4>{{ game.teamA.name }}</h4>
                                        {% for i in 1..3 %}
                                            <div class="form-group mb-3">
                                                <label class="form-label required">Zawodnik {{ i }}</label>
                                                <input type="text"
                                                       class="form-control player-search mb-2"
                                                       placeholder="Wyszukaj gracza..."
                                                       data-target="teamAPlayer{{ i }}">
                                                <select name="team[teamA][player{{ i }}]"
                                                        id="teamAPlayer{{ i }}"
                                                        class="form-select"
                                                        size="8">
                                                    <option value="">-- Wybierz zawodnika --</option>
                                                    {% for player in players %}
                                                        <option value="{{ player.id }}"
                                                                data-name="{{ player.fullName|lower }}"
                                                                data-league="{{ player.leagues|map(l => l.id)|join(',') }}">
                                                            {{ player.fullName }}
                                                            {% if player.leagues|length > 0 %}
                                                                <small class="text-muted">
                                                                    ({{ player.leagues|map(l => l.name)|join(', ') }})
                                                                </small>
                                                            {% endif %}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        {% endfor %}
                                    </div>

                                    <div class="col-md-6">
                                        <h4>{{ game.teamB.name }}</h4>
                                        {% for i in 1..3 %}
                                            <div class="form-group mb-3">
                                                <label class="form-label required">Zawodnik {{ i }}</label>
                                                <input type="text"
                                                       class="form-control player-search mb-2"
                                                       placeholder="Wyszukaj gracza..."
                                                       data-target="teamBPlayer{{ i }}">
                                                <select name="team[teamB][player{{ i }}]"
                                                        id="teamBPlayer{{ i }}"
                                                        class="form-select"
                                                        size="8">
                                                    <option value="">-- Wybierz zawodnika --</option>
                                                    {% for player in players %}
                                                        <option value="{{ player.id }}"
                                                                data-name="{{ player.fullName|lower }}"
                                                                data-league="{{ player.leagues|map(l => l.id)|join(',') }}">
                                                            {{ player.fullName }}
                                                            {% if player.leagues|length > 0 %}
                                                                <small class="text-muted">
                                                                    ({{ player.leagues|map(l => l.name)|join(', ') }})
                                                                </small>
                                                            {% endif %}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label class="form-label required">Początkowy tor</label>
                                    <input type="number"
                                           name="team[startLane]"
                                           class="form-control"
                                           value="1"
                                           min="1"
                                           max="20"
                                           required>
                                    <small class="form-text text-muted">Na którym torze rozpocznie się pierwszy mecz</small>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    Najpierw przypisz drużyny do meczu w edycji meczu.
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-check">
                            <input type="checkbox" id="filterByLeague" class="form-check-input">
                            <span class="form-check-label">Pokaż tylko graczy z ligi: <strong>{{ game.league.name }}</strong></span>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-magic"></i> Generuj strukturę meczu
                        </button>
                        <a href="{{ ea_url().setController('App\\Controller\\Admin\\GameCrudController').setAction('detail').setEntityId(game.id) }}"
                           class="btn btn-secondary">
                            <i class="fa fa-arrow-left"></i> Wróć
                        </a>
                    </div>
                </form>
            {% else %}
                <div class="alert alert-success">
                    <i class="fa fa-check-circle"></i> Mecz ma już wygenerowaną strukturę!
                </div>
                <a href="{{ ea_url().setController('App\\Controller\\Admin\\GameCrudController').setAction('detail').setEntityId(game.id) }}"
                   class="btn btn-primary">
                    <i class="fa fa-arrow-left"></i> Wróć do meczu
                </a>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const leagueId = '{{ game.league.id }}';
            const filterCheckbox = document.getElementById('filterByLeague');

            // Wyszukiwarka graczy
            document.querySelectorAll('.player-search').forEach(function(searchInput) {
                const targetId = searchInput.dataset.target;
                const selectElement = document.getElementById(targetId);

                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const options = selectElement.querySelectorAll('option');

                    options.forEach(function(option) {
                        if (option.value === '') {
                            option.style.display = '';
                            return;
                        }

                        const playerName = option.dataset.name || '';
                        const matchesSearch = playerName.includes(searchTerm);
                        const matchesLeague = !filterCheckbox.checked ||
                            option.dataset.league.split(',').includes(leagueId);

                        option.style.display = (matchesSearch && matchesLeague) ? '' : 'none';
                    });
                });
            });

            // Filtr po lidze
            filterCheckbox.addEventListener('change', function() {
                document.querySelectorAll('.player-search').forEach(function(searchInput) {
                    searchInput.dispatchEvent(new Event('input'));
                });
            });

            // Trigger initial filtering
            if (filterCheckbox.checked) {
                document.querySelectorAll('.player-search').forEach(function(searchInput) {
                    searchInput.dispatchEvent(new Event('input'));
                });
            }
        });
    </script>

    <style>
        .player-search {
            border-bottom: 2px solid #007bff;
        }
        .form-select[size] option:hover {
            background-color: #f8f9fa;
        }
        .nav-tabs .nav-link {
            cursor: pointer;
        }
    </style>
{% endblock %}
