{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content_title %}
    Wprowadź wyniki - Tor {{ frame.laneNumber }}
{% endblock %}

{% block main %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fa fa-bowling-ball"></i>
                        Mecz: {{ frame.game }}
                    </h3>
                    <p class="mb-0 mt-2">
                        <strong>Tor {{ frame.laneNumber }}</strong> |
                        Gra {{ frame.gameNumber }} |
                        {{ frame.game.gameDate|date('d.m.Y H:i') }}
                    </p>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ path('admin_frame_save_scores', {frameId: frame.id}) }}" id="scoreForm">

                        {# Tabela wyników w stylu bowling scorecard #}
                        <div class="bowling-input-table">
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                <tr>
                                    <th width="180">Gracz</th>
                                    {% for i in 1..10 %}
                                        <th class="text-center frame-header">
                                            <div class="frame-number">{{ i }}</div>
                                        </th>
                                    {% endfor %}
                                    <th class="text-center bg-warning">TOTAL</th>
                                </tr>
                                </thead>
                                <tbody>
                                {# Team A Players #}
                                {% for player in frame.teamAPlayers %}
                                    <tr class="player-row">
                                        <td class="player-name-cell">
                                            <div class="player-info">
                                                <strong>{{ player.fullName }}</strong>
                                                {% if frame.teamA %}
                                                    <br><small class="text-muted">{{ frame.teamA.name }}</small>
                                                {% endif %}
                                            </div>
                                        </td>

                                        {% for frameNum in 1..10 %}
                                            {% set currentFrame = null %}
                                            {% for f in frame.game.frames %}
                                                {% if f.laneNumber == frame.laneNumber
                                                    and f.gameNumber == frame.gameNumber
                                                    and f.frameNumber == frameNum %}
                                                    {% set currentFrame = f %}
                                                {% endif %}
                                            {% endfor %}

                                            <td class="frame-input-cell" data-frame="{{ frameNum }}">
                                                {% if currentFrame %}
                                                    {% set roll1 = currentFrame.getPlayerRoll(player, 1) %}
                                                    {% set roll2 = currentFrame.getPlayerRoll(player, 2) %}
                                                    {% set roll3 = currentFrame.getPlayerRoll(player, 3) %}

                                                    <div class="frame-inputs">
                                                        {# Rzut 1 #}
                                                        <input
                                                            type="number"
                                                            name="frames[{{ currentFrame.id }}][{{ player.id }}][roll1]"
                                                            class="form-control form-control-sm roll-input"
                                                            min="0"
                                                            max="10"
                                                            value="{{ roll1 ? roll1.pinsKnocked : '' }}"
                                                            placeholder="-"
                                                            data-frame-id="{{ currentFrame.id }}"
                                                            data-player-id="{{ player.id }}"
                                                            data-roll="1"
                                                        >

                                                        {# Rzut 2 #}
                                                        <input
                                                            type="number"
                                                            name="frames[{{ currentFrame.id }}][{{ player.id }}][roll2]"
                                                            class="form-control form-control-sm roll-input"
                                                            min="0"
                                                            max="10"
                                                            value="{{ roll2 ? roll2.pinsKnocked : '' }}"
                                                            placeholder="-"
                                                            data-frame-id="{{ currentFrame.id }}"
                                                            data-player-id="{{ player.id }}"
                                                            data-roll="2"
                                                        >

                                                        {# Rzut 3 (tylko dla framu 10) #}
                                                        {% if frameNum == 10 %}
                                                            <input
                                                                type="number"
                                                                name="frames[{{ currentFrame.id }}][{{ player.id }}][roll3]"
                                                                class="form-control form-control-sm roll-input"
                                                                min="0"
                                                                max="10"
                                                                value="{{ roll3 ? roll3.pinsKnocked : '' }}"
                                                                placeholder="-"
                                                                data-frame-id="{{ currentFrame.id }}"
                                                                data-player-id="{{ player.id }}"
                                                                data-roll="3"
                                                            >
                                                        {% endif %}
                                                    </div>

                                                    <div class="frame-score-display">
                                                        <small class="text-muted">
                                                            Score: <strong>{{ currentFrame.calculatePlayerScore(player) }}</strong>
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </td>
                                        {% endfor %}

                                        <td class="text-center total-score-cell">
                                            <h4 class="mb-0" id="total-{{ player.id }}">
                                                {{ frame.game.getPlayerTotalScore(player) }}
                                            </h4>
                                        </td>
                                    </tr>
                                {% endfor %}

                                {# Team B Players #}
                                {% for player in frame.teamBPlayers %}
                                    <tr class="player-row">
                                        <td class="player-name-cell">
                                            <div class="player-info">
                                                <strong>{{ player.fullName }}</strong>
                                                {% if frame.teamB %}
                                                    <br><small class="text-muted">{{ frame.teamB.name }}</small>
                                                {% endif %}
                                            </div>
                                        </td>

                                        {% for frameNum in 1..10 %}
                                            {% set currentFrame = null %}
                                            {% for f in frame.game.frames %}
                                                {% if f.laneNumber == frame.laneNumber
                                                    and f.gameNumber == frame.gameNumber
                                                    and f.frameNumber == frameNum %}
                                                    {% set currentFrame = f %}
                                                {% endif %}
                                            {% endfor %}

                                            <td class="frame-input-cell" data-frame="{{ frameNum }}">
                                                {% if currentFrame %}
                                                    {% set roll1 = currentFrame.getPlayerRoll(player, 1) %}
                                                    {% set roll2 = currentFrame.getPlayerRoll(player, 2) %}
                                                    {% set roll3 = currentFrame.getPlayerRoll(player, 3) %}

                                                    <div class="frame-inputs">
                                                        <input
                                                            type="number"
                                                            name="frames[{{ currentFrame.id }}][{{ player.id }}][roll1]"
                                                            class="form-control form-control-sm roll-input"
                                                            min="0"
                                                            max="10"
                                                            value="{{ roll1 ? roll1.pinsKnocked : '' }}"
                                                            placeholder="-"
                                                            data-frame-id="{{ currentFrame.id }}"
                                                            data-player-id="{{ player.id }}"
                                                            data-roll="1"
                                                        >

                                                        <input
                                                            type="number"
                                                            name="frames[{{ currentFrame.id }}][{{ player.id }}][roll2]"
                                                            class="form-control form-control-sm roll-input"
                                                            min="0"
                                                            max="10"
                                                            value="{{ roll2 ? roll2.pinsKnocked : '' }}"
                                                            placeholder="-"
                                                            data-frame-id="{{ currentFrame.id }}"
                                                            data-player-id="{{ player.id }}"
                                                            data-roll="2"
                                                        >

                                                        {% if frameNum == 10 %}
                                                            <input
                                                                type="number"
                                                                name="frames[{{ currentFrame.id }}][{{ player.id }}][roll3]"
                                                                class="form-control form-control-sm roll-input"
                                                                min="0"
                                                                max="10"
                                                                value="{{ roll3 ? roll3.pinsKnocked : '' }}"
                                                                placeholder="-"
                                                                data-frame-id="{{ currentFrame.id }}"
                                                                data-player-id="{{ player.id }}"
                                                                data-roll="3"
                                                            >
                                                        {% endif %}
                                                    </div>

                                                    <div class="frame-score-display">
                                                        <small class="text-muted">
                                                            Score: <strong>{{ currentFrame.calculatePlayerScore(player) }}</strong>
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </td>
                                        {% endfor %}

                                        <td class="text-center total-score-cell">
                                            <h4 class="mb-0" id="total-{{ player.id }}">
                                                {{ frame.game.getPlayerTotalScore(player) }}
                                            </h4>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <input type="hidden" name="_token" value="{{ csrf_token('frame_scores_' ~ frame.id) }}">

                        <div class="form-actions mt-4 d-flex justify-content-between align-items-center">
                            <div>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fa fa-save"></i> Zapisz wszystkie wyniki
                                </button>
                                <button type="button" class="btn btn-warning btn-lg ms-2" onclick="clearAll()">
                                    <i class="fa fa-eraser"></i> Wyczyść
                                </button>
                            </div>
                            <a href="{{ ea_url().setAction('viewFrames').setController('App\\Controller\\Admin\\GameCrudController').setEntityId(frame.game.id) }}" class="btn btn-secondary">
                                <i class="fa fa-arrow-left"></i> Powrót do meczu
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            {# Legenda #}
            <div class="card mt-3">
                <div class="card-body">
                    <h6><i class="fa fa-info-circle"></i> Instrukcje:</h6>
                    <ul class="mb-0">
                        <li>Wpisz liczbę zbitych kręgli dla każdego rzutu (0-10)</li>
                        <li>System automatycznie obliczy wyniki z bonusami za strike i spare</li>
                        <li>Strike (X) = 10 kręgli w pierwszym rzucie</li>
                        <li>Spare (/) = 10 kręgli w sumie po dwóch rzutach</li>
                        <li>W 10 framie możesz wykonać 3 rzuty jeśli zrobisz strike lub spare</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <style>
        .bowling-input-table {
            overflow-x: auto;
        }

        .bowling-input-table table {
            min-width: 1200px;
            font-size: 0.9rem;
        }

        .frame-header {
            background-color: #343a40;
            color: white;
            font-weight: bold;
            padding: 0.5rem;
        }

        .frame-number {
            font-size: 1.1rem;
        }

        .player-name-cell {
            background-color: #f8f9fa;
            font-weight: 600;
            vertical-align: middle;
        }

        .player-info {
            padding: 0.5rem;
        }

        .frame-input-cell {
            padding: 0.5rem !important;
            vertical-align: top;
            background-color: #fff;
        }

        .frame-inputs {
            display: flex;
            gap: 2px;
            justify-content: center;
            margin-bottom: 0.25rem;
        }

        .roll-input {
            width: 35px;
            height: 35px;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            padding: 0;
            border: 2px solid #dee2e6;
        }

        .roll-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .roll-input[value=""]:not(:focus) {
            background-color: #fff3cd;
        }

        .frame-score-display {
            text-align: center;
            font-size: 0.75rem;
        }

        .total-score-cell {
            background-color: #ffc107;
            vertical-align: middle;
            font-weight: bold;
        }

        .player-row:nth-child(odd) .frame-input-cell {
            background-color: #f8f9fa;
        }

        .player-row:hover {
            background-color: #e9ecef;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .roll-input {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const rollInputs = document.querySelectorAll('.roll-input');

            rollInputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateRoll(this);
                });

                // Enter key moves to next input
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextInput = getNextInput(this);
                        if (nextInput) {
                            nextInput.focus();
                            nextInput.select();
                        }
                    }
                });
            });

            function validateRoll(input) {
                const frameId = input.dataset.frameId;
                const playerId = input.dataset.playerId;
                const rollNum = parseInt(input.dataset.roll);
                const value = parseInt(input.value) || 0;

                // Walidacja zakresu
                if (value < 0 || value > 10) {
                    input.value = '';
                    return;
                }

                // Znajdź inne rzuty tego gracza w tym framie
                const roll1Input = document.querySelector(`input[data-frame-id="${frameId}"][data-player-id="${playerId}"][data-roll="1"]`);
                const roll2Input = document.querySelector(`input[data-frame-id="${frameId}"][data-player-id="${playerId}"][data-roll="2"]`);

                if (rollNum === 1 && value === 10) {
                    // Strike - wyłącz/wyczyść rzut 2 (chyba że to fram 10)
                    const frameNum = parseInt(input.closest('.frame-input-cell').dataset.frame);
                    if (frameNum !== 10 && roll2Input) {
                        roll2Input.value = '';
                        roll2Input.disabled = true;
                        roll2Input.style.backgroundColor = '#e9ecef';
                    }
                } else if (roll1Input && roll2Input && rollNum === 1) {
                    // Włącz rzut 2
                    roll2Input.disabled = false;
                    roll2Input.style.backgroundColor = '';
                }

                // Sprawdź sumę rzutów 1 i 2
                if (rollNum === 2 && roll1Input) {
                    const roll1Value = parseInt(roll1Input.value) || 0;
                    const frameNum = parseInt(input.closest('.frame-input-cell').dataset.frame);

                    if (frameNum !== 10 && roll1Value + value > 10) {
                        alert(`Suma rzutów nie może przekroczyć 10! (${roll1Value} + ${value} = ${roll1Value + value})`);
                        input.value = '';
                        return;
                    }
                }

                // Podświetl wypełnione pola
                if (value > 0) {
                    input.style.backgroundColor = value === 10 ? '#d4edda' : '#ffffff';
                    input.style.borderColor = value === 10 ? '#28a745' : '#dee2e6';
                }
            }

            function getNextInput(currentInput) {
                const allInputs = Array.from(document.querySelectorAll('.roll-input:not([disabled])'));
                const currentIndex = allInputs.indexOf(currentInput);
                return allInputs[currentIndex + 1];
            }
        });

        function clearAll() {
            if (confirm('Czy na pewno chcesz wyczyścić wszystkie wprowadzone wyniki?')) {
                document.querySelectorAll('.roll-input').forEach(input => {
                    input.value = '';
                    input.disabled = false;
                    input.style.backgroundColor = '';
                    input.style.borderColor = '';
                });
            }
        }
    </script>
{% endblock %}


{% block content_title %}
    Wprowadź wyniki - Fram {{ frame.frameNumber }} (Gra {{ frame.gameNumber }}, Tor {{ frame.laneNumber }})
{% endblock %}

{% block main %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3>Mecz: {{ frame.game }}</h3>
                    <p class="text-muted">
                        Fram {{ frame.frameNumber }} | Gra {{ frame.gameNumber }} | Tor {{ frame.laneNumber }}
                    </p>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ path('admin_frame_save_scores', {frameId: frame.id}) }}" id="scoreForm">
                        <div class="row">
                            <!-- Team A -->
                            <div class="col-md-6">
                                <h4 class="border-bottom pb-2">
                                    {% if frame.teamA %}
                                        {{ frame.teamA.name }}
                                    {% else %}
                                        Team A
                                    {% endif %}
                                </h4>

                                {% for player in frame.teamAPlayers %}
                                    <div class="player-rolls mb-4 p-3 border rounded">
                                        <h5>{{ player.fullName }}</h5>

                                        <div class="rolls-input">
                                            <!-- Rzut 1 -->
                                            <div class="mb-3">
                                                <label class="form-label">Rzut 1</label>
                                                <input
                                                    type="number"
                                                    name="teamA[{{ player.id }}][roll1]"
                                                    class="form-control roll-input"
                                                    min="0"
                                                    max="10"
                                                    value="{{ frame.getPlayerRoll(player, 1) ? frame.getPlayerRoll(player, 1).pinsKnocked : '' }}"
                                                    data-player="{{ player.id }}"
                                                    data-team="A"
                                                    data-roll="1"
                                                >
                                            </div>

                                            <!-- Rzut 2 -->
                                            <div class="mb-3" id="teamA_{{ player.id }}_roll2_wrapper">
                                                <label class="form-label">Rzut 2</label>
                                                <input
                                                    type="number"
                                                    name="teamA[{{ player.id }}][roll2]"
                                                    class="form-control roll-input"
                                                    min="0"
                                                    max="10"
                                                    value="{{ frame.getPlayerRoll(player, 2) ? frame.getPlayerRoll(player, 2).pinsKnocked : '' }}"
                                                    data-player="{{ player.id }}"
                                                    data-team="A"
                                                    data-roll="2"
                                                >
                                            </div>

                                            <!-- Rzut 3 (tylko dla framu 10) -->
                                            {% if frame.frameNumber == 10 %}
                                                <div class="mb-3" id="teamA_{{ player.id }}_roll3_wrapper">
                                                    <label class="form-label">Rzut 3</label>
                                                    <input
                                                        type="number"
                                                        name="teamA[{{ player.id }}][roll3]"
                                                        class="form-control roll-input"
                                                        min="0"
                                                        max="10"
                                                        value="{{ frame.getPlayerRoll(player, 3) ? frame.getPlayerRoll(player, 3).pinsKnocked : '' }}"
                                                        data-player="{{ player.id }}"
                                                        data-team="A"
                                                        data-roll="3"
                                                    >
                                                </div>
                                            {% endif %}

                                            <div class="alert alert-info">
                                                Aktualny wynik: <strong>{{ frame.calculatePlayerScore(player) }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Team B -->
                            <div class="col-md-6">
                                <h4 class="border-bottom pb-2">
                                    {% if frame.teamB %}
                                        {{ frame.teamB.name }}
                                    {% else %}
                                        Team B
                                    {% endif %}
                                </h4>

                                {% for player in frame.teamBPlayers %}
                                    <div class="player-rolls mb-4 p-3 border rounded">
                                        <h5>{{ player.fullName }}</h5>

                                        <div class="rolls-input">
                                            <!-- Rzut 1 -->
                                            <div class="mb-3">
                                                <label class="form-label">Rzut 1</label>
                                                <input
                                                    type="number"
                                                    name="teamB[{{ player.id }}][roll1]"
                                                    class="form-control roll-input"
                                                    min="0"
                                                    max="10"
                                                    value="{{ frame.getPlayerRoll(player, 1) ? frame.getPlayerRoll(player, 1).pinsKnocked : '' }}"
                                                    data-player="{{ player.id }}"
                                                    data-team="B"
                                                    data-roll="1"
                                                >
                                            </div>

                                            <!-- Rzut 2 -->
                                            <div class="mb-3" id="teamB_{{ player.id }}_roll2_wrapper">
                                                <label class="form-label">Rzut 2</label>
                                                <input
                                                    type="number"
                                                    name="teamB[{{ player.id }}][roll2]"
                                                    class="form-control roll-input"
                                                    min="0"
                                                    max="10"
                                                    value="{{ frame.getPlayerRoll(player, 2) ? frame.getPlayerRoll(player, 2).pinsKnocked : '' }}"
                                                    data-player="{{ player.id }}"
                                                    data-team="B"
                                                    data-roll="2"
                                                >
                                            </div>

                                            <!-- Rzut 3 (tylko dla framu 10) -->
                                            {% if frame.frameNumber == 10 %}
                                                <div class="mb-3" id="teamB_{{ player.id }}_roll3_wrapper">
                                                    <label class="form-label">Rzut 3</label>
                                                    <input
                                                        type="number"
                                                        name="teamB[{{ player.id }}][roll3]"
                                                        class="form-control roll-input"
                                                        min="0"
                                                        max="10"
                                                        value="{{ frame.getPlayerRoll(player, 3) ? frame.getPlayerRoll(player, 3).pinsKnocked : '' }}"
                                                        data-player="{{ player.id }}"
                                                        data-team="B"
                                                        data-roll="3"
                                                    >
                                                </div>
                                            {% endif %}

                                            <div class="alert alert-info">
                                                Aktualny wynik: <strong>{{ frame.calculatePlayerScore(player) }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <input type="hidden" name="_token" value="{{ csrf_token('frame_scores_' ~ frame.id) }}">

                        <div class="form-actions mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-save"></i> Zapisz wyniki
                            </button>
                            <a href="{{ ea_url().setAction('index').setController('App\\Controller\\Admin\\FrameCrudController') }}" class="btn btn-secondary">
                                Anuluj
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const rollInputs = document.querySelectorAll('.roll-input');

            rollInputs.forEach(input => {
                input.addEventListener('change', function() {
                    validateRolls(this);
                });
            });

            function validateRolls(changedInput) {
                const player = changedInput.dataset.player;
                const team = changedInput.dataset.team;
                const roll = parseInt(changedInput.dataset.roll);

                const roll1Input = document.querySelector(`input[data-player="${player}"][data-team="${team}"][data-roll="1"]`);
                const roll2Input = document.querySelector(`input[data-player="${player}"][data-team="${team}"][data-roll="2"]`);

                if (roll === 1 && roll1Input.value) {
                    const roll1Value = parseInt(roll1Input.value);

                    // Jeśli strike, ukryj/wyczyść rzut 2 (chyba że fram 10)
                    if (roll1Value === 10 && {{ frame.frameNumber }} !== 10) {
                        if (roll2Input) {
                            roll2Input.value = '';
                            roll2Input.disabled = true;
                        }
                    } else {
                        if (roll2Input) {
                            roll2Input.disabled = false;
                            // Ogranicz max dla rzutu 2
                            roll2Input.max = 10 - roll1Value;
                        }
                    }
                }

                // Walidacja sumy rzutów 1 i 2
                if (roll === 2 && roll1Input && roll2Input) {
                    const roll1Value = parseInt(roll1Input.value) || 0;
                    const roll2Value = parseInt(roll2Input.value) || 0;

                    if (roll1Value + roll2Value > 10 && {{ frame.frameNumber }} !== 10) {
                        alert('Suma rzutów nie może przekroczyć 10!');
                        roll2Input.value = '';
                    }
                }
            }
        });
    </script>

    <style>
        .player-rolls {
            background-color: #f8f9fa;
        }
        .player-rolls h5 {
            color: #495057;
            margin-bottom: 1rem;
        }
        input[type="number"]:disabled {
            background-color: #e9ecef;
        }
    </style>
{% endblock %}
